<div class="cldownload">
    <button type="button" data-role="button" data-icon="download" onclick="downloadobl();">Скачать обложку</button>
</div>
<div id="id_edit_obloz">
    <article class="block-news">
        <div id="dle-content">
            <div class="dle-center">

            </div>
        </div>
    </article>
    <div style="margin-top: 10px;">
        <input name="obloz" id="oblozfile" type="file" style="height:auto" onchange="oblimagesbuild(this)" accept=".jpg,.png" />
        <input type="hidden" name="baseimg">
        <div class="k-form-hint"><span>Вы можете загружать только: JPG, PNG</span></div>
    </div>
</div>
<div class="delobloz">
    <button type="button" data-role="button" data-icon="delete" onclick="removeobloz();">Удалить обложку</button>
</div>
<div id="buttonContainer">
    <p>
        <button type="button" data-role="button" data-icon="save" class="k-button-solid-primary" onclick="saveobloz();">Сохранить</button>
        <button type="button" data-role="button" data-icon="close" onclick="$('#ideditobloz').data('kendoWindow').close();">Отмена</button>
    </p>
</div>


<script>
    function downloadobl() {
        el = $('#ideditcategor')[0];
        if (!el) {
            if (!$('#gbobloz')[0])
                fin = '.circleimg'
            else
                fin = '.titavatar';

            var bg = $('#id_edit_obloz').find(fin).css('background-image');
            bg = bg.replace('url(', '').replace(')', '').replace(/\"/gi, "");
            names = '.shottitle';
        } else {
            bg = $(el).find('img').attr('src');
            names = '.catname';
        }
        var a = document.createElement('a');
        a.href = bg;
        a.download = $('#id_edit_obloz').find(names).text();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function removeobloz() {
        el = $('#ideditcategor')[0];
        if (!el) {
            if (!$('#gbobloz')[0])
                fin = '.circleimg'
            else
                fin = '.titavatar';
            $('#id_edit_obloz').find(fin).css('background-image', 'url(/templates/Default/dleimages/bz.png)');
        } else
            $(el).find('img').attr('src', '/templates/Default/dleimages/no_icon.png');
        $("[name=baseimg]").val('del');

    }

    function saveobloz() {
        $('#ideditobloz').data('kendoWindow').close();
        if ($("[name=baseimg]").val() == "") {
            return;
        }
        el = $('#ideditcategor')[0];
        globloz = 0;
        if (!el) {
            catid = $("#id_edit_obloz ol").attr('cat');
            idcategory = $("#id_edit_obloz ol").attr('idcat');
            project = $("#id_edit_obloz ol").attr('project');
            if ($('#gbobloz')[0])
                globloz = 1;

        } else {
            project = getUrlParameter('project');
            if (project = 'false')
                catid = 1
            else
                catid = 2;
            idcategory = $("#ideditcategor").attr('data-cat');
        }
        dt = {
            rezim: 'izmenobloz',
            category: catid,
            idcategory: idcategory,
            project: project,
            imgbz: $("[name=baseimg]").val(),
            globloz: globloz,
        }
        getajax('/php/add_bz.php', dt);
    }

    function oblimagesbuild(el) {
        var file = $(el).get(0);
        var file64 = el.files[0];
        var reader = new FileReader();
        reader.onloadend = function() {
            $("[name=baseimg]").val(reader.result)
        }
        reader.readAsDataURL(file64);
        var preview = window.URL.createObjectURL(file.files[0]);
        els = $('#ideditcategor')[0];
        if (!els) {
            if (!$('#gbobloz')[0])
                fin = '.circleimg'
            else
                fin = '.titavatar';
            $(el).closest('#id_edit_obloz').find(fin).css('background-image', 'url(' + preview + ')');
        } else {
            $(els).find('img').attr('src', preview);
        }
    }
    kendo.init("#buttonContainer");
    kendo.init(".delobloz");
    kendo.init(".cldownload");
</script>